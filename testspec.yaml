version: 0.2

env:
  variables:
    # REPOSITORY_URI and IMAGE_TAG are just placeholders to validate the CF template
    REPOSITORY_URI: "mock"
    IMAGE_TAG: "mock"
    CODEBUILD_RESOLVED_SOURCE_VERSION: "mock"
    #DATABASE_URL: "mysql://docker:docker@localhost:16603/docker?atomic_requests=1&init_command=SET sql_mode='STRICT_TRANS_TABLES'"
    DATABASE_URL: "mysql://docker:docker@localhost:3306/docker?atomic_requests=1&init_command=SET sql_mode='STRICT_TRANS_TABLES'"


phases:
  install:
    run-as: root
    commands:
      - which docker || echo "docker not found"
      - python3 -V
      - apt-get update -qq
      - apt-get install -qq -y mysql-client
      - /usr/local/bin/dockerd-entrypoint.sh
      - docker network create gen3-api-layer
      - echo "Start MySQL docker container"
      - docker-compose up -d db
      #- docker run --detach --name=test-mysql -e MYSQL_ROOT_PASSWORD=docker -e MYSQL_DATABASE=docker -e MYSQL_USER=docker -e MYSQL_PASSWORD=docker --publish 16603:3306 mysql:5.6
      - pip install --upgrade pip awscli
      - pip install -r requirements/test.txt
      - pip install -r requirements/build.txt

  build:
    commands:
      # - echo "$CODEBUILD_INITIATOR" | grep GitHub && flake8 | lintly --log || true
      - python manage.py wait_until_database_ready
      - pytest --cache-clear
  post_build:
    commands:
      - echo "Tests finally working"
cache:
  paths:
    - "/root/.cache/pip/**/*"
    - "/root/.cache/codecov.sh"
